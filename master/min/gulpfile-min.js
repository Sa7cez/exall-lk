function handleError(s){log(s.toString()),this.emit("end")}function flipcss(s){s||(s={});var e=through.obj(function(e,p,t){if(e.isNull())return t(null,e);e.isStream()&&console.log("todo: isStream!");var a=flip(String(e.contents),s);e.contents=new Buffer(a),t(null,e)});return e}function log(s){$.util.log($.util.colors.blue(s))}function templatePagesTask(s){return function(){return log("Building pages.."),gulp.src(source.templates.pages.files).pipe($["if"](!s,$.changed(build.templates.pages,{extension:".html"}))).pipe($.filter(function(s){return!/[\/\\]_/.test(s.path)&&!/[\/\\]_/.test(s.relative)&&!/^_/.test(s.relative)})).pipe($.jade()).on("error",handleError).pipe($.htmlPrettify(prettifyOpts)).pipe(gulp.dest(build.templates.pages))}}function templatesViewTask(s){return function(){return log("Building views.."),gulp.src(source.templates.views.files).pipe($["if"](!s,$.changed(build.templates.views,{extension:".html"}))).pipe($.filter(function(s){return!/[\/\\]_/.test(s.path)&&!/[\/\\]_/.test(s.relative)&&!/^_/.test(s.relative)})).pipe($.jade({locals:require("./sidebar.json")})).on("error",handleError).pipe($.htmlPrettify(prettifyOpts)).pipe(gulp.dest(build.templates.views))}}var args=require("yargs").argv,path=require("path"),flip=require("css-flip"),through=require("through2"),gulp=require("gulp"),$=require("gulp-load-plugins")(),gulpsync=$.sync(gulp),PluginError=$.util.PluginError,isProduction=!1,useSourceMaps=!1,useSass=args.usesass,hidden_files="**/_*.*",ignored_files="!"+hidden_files,paths={app:"../app/",markup:"jade/",styles:"less/",scripts:"js/"};useSass&&(log("Using SASS stylesheets..."),paths.styles="sass/");var vendor={app:{source:require("./vendor.json"),dest:"../vendor"}},source={scripts:{app:[paths.scripts+"app.init.js",paths.scripts+"modules/*.js",paths.scripts+"custom/custom.js"],demo:paths.scripts+"modules/demo/*.js"},templates:{app:{files:[paths.markup+"index.jade"],watch:[paths.markup+"index.jade",paths.markup+hidden_files]},partials:{layout:[paths.markup+"_*.*"],views:[paths.markup+"views/**/_*.*"],pages:[paths.markup+"pages/**/_*.*"]},views:{files:[paths.markup+"views/**/*.jade"],watch:[paths.markup+"views/**/*.jade"]},pages:{files:[paths.markup+"pages/*.jade"],watch:[paths.markup+"pages/*.jade"]}},styles:{app:[paths.styles+"*.*"],themes:[paths.styles+"themes/*",ignored_files],watch:[paths.styles+"**/*","!"+paths.styles+"themes/*"]}},build={scripts:{app:{main:"app.js",dir:paths.app+"js"},demo:paths.app+"js/demo"},styles:paths.app+"css",templates:{views:paths.app,pages:paths.app}},prettifyOpts={indent_char:" ",indent_size:3,unformatted:["a","sub","sup","b","i","u","pre","code"]},vendorUglifyOpts={mangle:{except:["$super"]}},compassOpts={project:path.join(__dirname,"../"),css:"app/css",sass:"master/sass/",image:"app/img"},compassOptsThemes={project:path.join(__dirname,"../"),css:"app/css",sass:"master/sass/themes/",image:"app/img"};gulp.task("scripts:app",function(){return log("Building scripts.."),gulp.src(source.scripts.app).pipe($.jsvalidate()).on("error",handleError).pipe($["if"](useSourceMaps,$.sourcemaps.init())).pipe($.concat(build.scripts.app.main)).on("error",handleError).pipe($["if"](isProduction,$.uglify({preserveComments:"some"}))).on("error",handleError).pipe($["if"](useSourceMaps,$.sourcemaps.write())).pipe(gulp.dest(build.scripts.app.dir))}),gulp.task("vendor",function(){log("Copying vendor assets..");var s=$.filter("**/*.js"),e=$.filter("**/*.css");return gulp.src(vendor.app.source,{base:"bower_components"}).pipe($.expectFile(vendor.app.source)).pipe(s).pipe($["if"](isProduction,$.uglify(vendorUglifyOpts))).pipe(s.restore()).pipe(e).pipe($["if"](isProduction,$.minifyCss())).pipe(e.restore()).pipe(gulp.dest(vendor.app.dest))}),gulp.task("scripts:demo",function(){return gulp.src(source.scripts.demo).pipe(gulp.dest(build.scripts.demo))}),gulp.task("styles:app",function(){return log("Building application styles.."),gulp.src(source.styles.app).pipe($["if"](useSourceMaps,$.sourcemaps.init())).pipe(useSass?$.compass(compassOpts):$.less()).on("error",handleError).pipe($["if"](isProduction,$.minifyCss())).pipe($["if"](useSourceMaps,$.sourcemaps.write())).pipe(gulp.dest(build.styles))}),gulp.task("styles:app:rtl",function(){return log("Building application RTL styles.."),gulp.src(source.styles.app).pipe($["if"](useSourceMaps,$.sourcemaps.init())).pipe(useSass?$.compass(compassOpts):$.less()).on("error",handleError).pipe(flipcss()).pipe($["if"](isProduction,$.minifyCss())).pipe($["if"](useSourceMaps,$.sourcemaps.write())).pipe($.rename(function(s){return s.basename+="-rtl",s})).pipe(gulp.dest(build.styles))}),gulp.task("styles:themes",function(){return log("Building application theme styles.."),gulp.src(source.styles.themes).pipe(useSass?$.compass(compassOptsThemes):$.less()).on("error",handleError).pipe(gulp.dest(build.styles))}),gulp.task("templates:pages",templatePagesTask()),gulp.task("templates:pages:forced",templatePagesTask(!0)),gulp.task("templates:views",templatesViewTask()),gulp.task("templates:views:forced",templatesViewTask(!0)),gulp.task("watch",function(){log("Starting watch and LiveReload.."),$.livereload.listen(),gulp.watch(source.scripts.app,["scripts:app"]),gulp.watch(source.scripts.demo,["scripts:demo"]),gulp.watch(source.styles.watch,["styles:app","styles:app:rtl"]),gulp.watch(source.styles.themes,["styles:themes"]),gulp.watch(source.templates.pages.watch,["templates:pages"]),gulp.watch(source.templates.views.watch,["templates:views"]),gulp.watch(source.templates.partials.layout,["templates:views:forced","templates:pages:forced"]),gulp.watch(source.templates.partials.views,["templates:views:forced"]),gulp.watch(source.templates.partials.pages,["templates:pages:forced"]);var s=1500,e=[].concat(source.scripts.app,source.scripts.demo,source.styles.watch,source.styles.themes,source.templates.pages.watch,source.templates.views.watch);gulp.watch(e).on("change",function(e){setTimeout(function(){$.livereload.changed(e.path)},s)})}),gulp.task("build",gulpsync.sync(["prod","vendor","assets"])),gulp.task("prod",function(){log("Starting production build..."),isProduction=!0}),gulp.task("sourcemaps",["usesources","default"]),gulp.task("usesources",function(){useSourceMaps=!0}),gulp.task("default",gulpsync.sync(["vendor","assets","watch"]),function(){log("************"),log("* All Done * You can start editing your code, LiveReload will update your browser after any change.."),log("************")}),gulp.task("assets",["scripts:app","scripts:demo","styles:app","styles:app:rtl","styles:themes","templates:pages","templates:views"]);